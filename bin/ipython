#!/bin/bash

# IPython executable name (because it could be ipython-2.7, for example...)
IPY_NAME=$(basename "$0")

SELFMAGIC="__ipython_eups_trampoline_script_file__"

# Find the real IPython executable
while IFS='' read IPYTHON; do
	# Skip over self
	cmp -s "$0" "$IPYTHON" && continue
	# Skip over any file that looks like an older (or packed) version of self
	grep -q "$SELFMAGIC" "$IPYTHON" && continue
	# Found acceptable IPython
	break
done < <(which -a "$IPY_NAME")

# What's the variable that controls the dynamic linker lookup path?
case $(uname) in
	Darwin)
		LDLP_NAME='DYLD_LIBRARY_PATH'
		;;
	*)
		LDLP_NAME='LD_LIBRARY_PATH'
		;;
esac

cleanup_temp_linkfarm()
{
	# Cautiously clean up the linkfarm
	LIBDIR="$IPYTHON_EUPS_LIB_LINKFARM/lib"
	if [[ -L "$LIBDIR" ]]; then
		find "$LIBDIR/" -type l -delete		# Remove directory contents (expecting only symlinks!)
		RESOLVED_DIR=$(cd $LIBDIR/; pwd -P)
		rmdir "$RESOLVED_DIR"/;			# Remove the directory itself
		rm -f "$LIBDIR"				# Remove the symlink
	fi

	PYDIR="$IPYTHON_EUPS_LIB_LINKFARM/python"	# Python directory for extracted module
	if [[ -d "$PYDIR" ]]; then
		rm -f "$PYDIR"/eups_magic.py*
		rmdir "$PYDIR"
	fi

	rmdir "$IPYTHON_EUPS_LIB_LINKFARM"		# Remove the linkfarm directory
}

# Create the linkfarm dir, prepend it to LD_LIBRARY_PATH
if [[ -z $IPYTHON_EUPS_LIB_LINKFARM ]]; then
	# Create a temporary linkfarm directory. The linkfarm will be in the lib/
	# subdirectory of this directory.
	export IPYTHON_EUPS_LIB_LINKFARM="$(mktemp -d -t ipython-eups-linkfarm.XXXXX)"

	# Cleanup on exit
	trap "{ cleanup_temp_linkfarm; }" EXIT
fi
#echo IPYTHON_EUPS_LIB_LINKFARM=$IPYTHON_EUPS_LIB_LINKFARM
export $LDLP_NAME="$IPYTHON_EUPS_LIB_LINKFARM/lib:${!LDLP_NAME}"

#echo $LDLP_NAME=${!LDLP_NAME}

# Check if the eups_magics.py module has been pasted to the end of ourselves
EXTRACTPY=0
MAGIC="EMBEDDED""_PYTHON_MODULE----------"
if grep -q "$MAGIC" "$0"; then
	# Extract the Python module into $IPYTHON_EUPS_LIB_LINKFARM/python
	PYDIR="$IPYTHON_EUPS_LIB_LINKFARM/python"
	mkdir -p "$PYDIR"

	# Do the extraction; 
	STARTLINE=$(grep -n "$MAGIC" "$0" | head -n 1 | cut -d : -f 1)
	(( STARTLINE += 1 ))
	tail -n +"$STARTLINE" "$0" > "$PYDIR/eups_magic.py"

	# Add PYDIR to PYTHONPATH
	export PYTHONPATH="$PYDIR:$PYTHONPATH"
fi

# Run the real IPython
"$IPYTHON" "$@"
